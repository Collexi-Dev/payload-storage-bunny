{"version":3,"sources":["../src/handleUpload.ts"],"sourcesContent":["import type { HandleUpload } from '@payloadcms/plugin-cloud-storage/types'\n\nimport ky, { HTTPError } from 'ky'\nimport { posix } from 'node:path'\nimport { APIError } from 'payload'\n\nimport type { BunnyAdapterOptions } from './types.js'\n\nimport { getStorageUrl } from './utils.js'\n\ntype Args = { prefix?: string } & BunnyAdapterOptions\n\nexport const getHandleUpload = ({ prefix, storage, stream }: Args): HandleUpload => {\n  return async ({ data, file, req }) => {\n    data.url = null\n    data.thumbnailURL = null\n\n    try {\n      const fileName = file.filename\n      const filePath = posix.join(prefix || '', fileName)\n      const isVideoFile = file.mimeType.startsWith('video/')\n\n      if (stream && isVideoFile) {\n        const { guid } = await ky\n          .post<{ guid: string }>(`https://video.bunnycdn.com/library/${stream.libraryId}/videos`, {\n            headers: {\n              accept: 'application/json',\n              AccessKey: stream.apiKey,\n              'content-type': 'application/json',\n            },\n            json: { thumbnailTime: stream.thumbnailTime, title: fileName },\n            timeout: 120000,\n          })\n          .json()\n\n        await ky.put(`https://video.bunnycdn.com/library/${stream.libraryId}/videos/${guid}`, {\n          body: file.buffer,\n          headers: {\n            accept: 'application/json',\n            AccessKey: stream.apiKey,\n          },\n          timeout: 120000,\n        })\n\n        data.filename = fileName\n        data.bunnyVideoId = guid\n      } else {\n        await ky.put(`https://${getStorageUrl(storage.region)}/${storage.zoneName}/${filePath}`, {\n          body: file.buffer,\n          headers: {\n            accept: 'application/json',\n            AccessKey: storage.apiKey,\n            'content-type': file.mimeType,\n          },\n          timeout: 120000,\n        })\n\n        data.filename = fileName\n        data.bunnyVideoId = null\n      }\n\n      return data\n    } catch (err: unknown) {\n      if (err instanceof HTTPError) {\n        const errorResponse = await err.response.text()\n\n        req.payload.logger.error({\n          error: {\n            response: errorResponse,\n            status: err.response.status,\n            statusText: err.response.statusText,\n          },\n          file: {\n            name: file.filename,\n            type: file.mimeType,\n            size: file.filesize,\n          },\n          storage: storage.zoneName,\n        })\n      } else {\n        req.payload.logger.error({\n          error: err,\n          file: {\n            name: file.filename,\n            type: file.mimeType,\n            size: file.filesize,\n          },\n          storage: storage.zoneName,\n        })\n      }\n\n      throw new APIError(`Error uploading file: ${file.filename}.`, 500)\n    }\n  }\n}\n"],"names":["ky","HTTPError","posix","APIError","getStorageUrl","getHandleUpload","prefix","storage","stream","data","file","req","url","thumbnailURL","fileName","filename","filePath","join","isVideoFile","mimeType","startsWith","guid","post","libraryId","headers","accept","AccessKey","apiKey","json","thumbnailTime","title","timeout","put","body","buffer","bunnyVideoId","region","zoneName","err","errorResponse","response","text","payload","logger","error","status","statusText","name","type","size","filesize"],"mappings":"AAEA,OAAOA,MAAMC,SAAS,QAAQ,KAAI;AAClC,SAASC,KAAK,QAAQ,YAAW;AACjC,SAASC,QAAQ,QAAQ,UAAS;AAIlC,SAASC,aAAa,QAAQ,aAAY;AAI1C,OAAO,MAAMC,kBAAkB,CAAC,EAAEC,MAAM,EAAEC,OAAO,EAAEC,MAAM,EAAQ;IAC/D,OAAO,OAAO,EAAEC,IAAI,EAAEC,IAAI,EAAEC,GAAG,EAAE;QAC/BF,KAAKG,GAAG,GAAG;QACXH,KAAKI,YAAY,GAAG;QAEpB,IAAI;YACF,MAAMC,WAAWJ,KAAKK,QAAQ;YAC9B,MAAMC,WAAWd,MAAMe,IAAI,CAACX,UAAU,IAAIQ;YAC1C,MAAMI,cAAcR,KAAKS,QAAQ,CAACC,UAAU,CAAC;YAE7C,IAAIZ,UAAUU,aAAa;gBACzB,MAAM,EAAEG,IAAI,EAAE,GAAG,MAAMrB,GACpBsB,IAAI,CAAmB,CAAC,mCAAmC,EAAEd,OAAOe,SAAS,CAAC,OAAO,CAAC,EAAE;oBACvFC,SAAS;wBACPC,QAAQ;wBACRC,WAAWlB,OAAOmB,MAAM;wBACxB,gBAAgB;oBAClB;oBACAC,MAAM;wBAAEC,eAAerB,OAAOqB,aAAa;wBAAEC,OAAOhB;oBAAS;oBAC7DiB,SAAS;gBACX,GACCH,IAAI;gBAEP,MAAM5B,GAAGgC,GAAG,CAAC,CAAC,mCAAmC,EAAExB,OAAOe,SAAS,CAAC,QAAQ,EAAEF,MAAM,EAAE;oBACpFY,MAAMvB,KAAKwB,MAAM;oBACjBV,SAAS;wBACPC,QAAQ;wBACRC,WAAWlB,OAAOmB,MAAM;oBAC1B;oBACAI,SAAS;gBACX;gBAEAtB,KAAKM,QAAQ,GAAGD;gBAChBL,KAAK0B,YAAY,GAAGd;YACtB,OAAO;gBACL,MAAMrB,GAAGgC,GAAG,CAAC,CAAC,QAAQ,EAAE5B,cAAcG,QAAQ6B,MAAM,EAAE,CAAC,EAAE7B,QAAQ8B,QAAQ,CAAC,CAAC,EAAErB,UAAU,EAAE;oBACvFiB,MAAMvB,KAAKwB,MAAM;oBACjBV,SAAS;wBACPC,QAAQ;wBACRC,WAAWnB,QAAQoB,MAAM;wBACzB,gBAAgBjB,KAAKS,QAAQ;oBAC/B;oBACAY,SAAS;gBACX;gBAEAtB,KAAKM,QAAQ,GAAGD;gBAChBL,KAAK0B,YAAY,GAAG;YACtB;YAEA,OAAO1B;QACT,EAAE,OAAO6B,KAAc;YACrB,IAAIA,eAAerC,WAAW;gBAC5B,MAAMsC,gBAAgB,MAAMD,IAAIE,QAAQ,CAACC,IAAI;gBAE7C9B,IAAI+B,OAAO,CAACC,MAAM,CAACC,KAAK,CAAC;oBACvBA,OAAO;wBACLJ,UAAUD;wBACVM,QAAQP,IAAIE,QAAQ,CAACK,MAAM;wBAC3BC,YAAYR,IAAIE,QAAQ,CAACM,UAAU;oBACrC;oBACApC,MAAM;wBACJqC,MAAMrC,KAAKK,QAAQ;wBACnBiC,MAAMtC,KAAKS,QAAQ;wBACnB8B,MAAMvC,KAAKwC,QAAQ;oBACrB;oBACA3C,SAASA,QAAQ8B,QAAQ;gBAC3B;YACF,OAAO;gBACL1B,IAAI+B,OAAO,CAACC,MAAM,CAACC,KAAK,CAAC;oBACvBA,OAAON;oBACP5B,MAAM;wBACJqC,MAAMrC,KAAKK,QAAQ;wBACnBiC,MAAMtC,KAAKS,QAAQ;wBACnB8B,MAAMvC,KAAKwC,QAAQ;oBACrB;oBACA3C,SAASA,QAAQ8B,QAAQ;gBAC3B;YACF;YAEA,MAAM,IAAIlC,SAAS,CAAC,sBAAsB,EAAEO,KAAKK,QAAQ,CAAC,CAAC,CAAC,EAAE;QAChE;IACF;AACF,EAAC"}